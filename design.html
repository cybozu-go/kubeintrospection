<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Design notes - NecoPerf Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">NecoPerf Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/cybozu-go/necoperf" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/cybozu-go/necoperf/edit/main/docs/./design.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="design-document"><a class="header" href="#design-document">Design Document</a></h1>
<p>NecoPerf provides an easy mechanism for cpu profiling in Kubernetes multi-tenancy without giving users strong permissions.</p>
<h2 id="context-and-scope"><a class="header" href="#context-and-scope">Context and Scope</a></h2>
<p>Currently, it is possible to retrieve cpu profiling using <a href="https://perf.wiki.kernel.org/index.php/Main_Page">Linux perf</a> for application running on Kubernetes.
But it requires a lot of manual operations and strong permissions.
To solve these problems, we provide NecoPerf, a mechanism to more easily retrieve cpu profiling for application.
NecoPerf can automate many manual operations.</p>
<h3 id="goals"><a class="header" href="#goals">Goals</a></h3>
<ul>
<li>Provides a system for users to easily run perf command and retrieve cpu profiling for application</li>
<li>NecoPerf users can specify options when running perf command</li>
</ul>
<h3 id="non-goals"><a class="header" href="#non-goals">Non-goals</a></h3>
<ul>
<li>Support for various operating systems (initial implementation supports Flatcar Linux only)</li>
<li>Support TLS</li>
<li>Profiling of child processes
<ul>
<li>e.g. container run by <a href="https://github.com/krallin/tini">tini</a></li>
</ul>
</li>
<li>Continuous Profiling</li>
<li>Processing and visualization of profile data, including conversion to <a href="https://github.com/brendangregg/FlameGraph">FlameGraph</a></li>
</ul>
<h2 id="proposal"><a class="header" href="#proposal">Proposal</a></h2>
<h3 id="user-stories"><a class="header" href="#user-stories">User Stories</a></h3>
<p>This section describes the actual flow of a situation when a user uses perf command to retrieve profiling.</p>
<ul>
<li>
<p>The assumption is that the Kubernetes cluster in User stories is used in a multi-tenancy</p>
<ul>
<li>There is a team managing the cluster and several teams using the cluster</li>
<li>The team that uses the cluster is called the tenant</li>
<li>Tenant do not have strong privileges</li>
<li>The team managing the Kubernetes cluster is called cluster admin</li>
</ul>
</li>
<li>
<p>Tenant are aware that there are performance issues with their application and want to do a cpu profile them using perf command to identify bottlenecks.
However, a lot of things need to be done manually, as the following steps are required to run perf command</p>
<ol>
<li>Install a perf that is compatible with the kernel version of the host operating system in the container image</li>
<li>Modify the manifest to add a sidecar or ephemeral container with the necessary permissions to run perf</li>
<li>The user of tenant enters a sidecar or ephemeral container and executes perf command against the target container to retrieve the cpu profile</li>
</ol>
</li>
<li>
<p>Cluster Admin wants to minimize the permissions granted to the tenant.
However, to run perf, the tenant needs to be able to grant  <code>CAP_SYS_ADMIN</code> and <code>CAP_SYS_PTRACE</code> permissions to the pod, which violates the principle of least privilege.</p>
</li>
</ul>
<p>NecoPerf does not require manual operations and allows for easy cpu profiling for application using perf command.</p>
<h3 id="constraints"><a class="header" href="#constraints">Constraints</a></h3>
<ul>
<li>Debug symbols are required for perf to resolve symbols.
These debug symbols must be included in the container image to be profiled</li>
<li>NecoPerf performs cpu profiling based on the PID of the application, so if the target process is killed during profiling, profiling will not continue and will terminate</li>
</ul>
<h3 id="risk-and-mitigations"><a class="header" href="#risk-and-mitigations">Risk and Mitigations</a></h3>
<ul>
<li>Security Risk
<ul>
<li>Originally, <code>CAP_SYSLOG</code>, <code>CAP_SYS_ADMIN</code>, <code>CAP_SYS_CHROOT</code> and other permissions are required to run perf command, but using necoperf is safe because it is not necessary to give those permissions to tenant.
On the other hand, deploying necoperf requires the permission to run <code>CAP_SYSLOG</code> and CRI APIs, so it should be managed correctly so that ordinary users cannot misuse it.</li>
</ul>
</li>
<li>Performance Risk
<ul>
<li>To prevent tenant from running perf for long periods, the NecoPerf validates the values from the user request</li>
</ul>
</li>
</ul>
<h2 id="the-actual-design"><a class="header" href="#the-actual-design">The actual design</a></h2>
<p>The first implementation creates a gRPC server that simply runs perf command on the specified container id and returns the profiling results.
The perf command is used to retrieve profiling and convert the retrieved profiling data.</p>
<p>We also create a command line tool as a client to send requests to the gRPC server.
This command line tool queries the Kubernetes API server based on the pod and container name entered by the user and retrieves the container id.
The command line tool sends a profiling request to the gRPC server based on the retrieved container id.</p>
<pre><code class="language-console">necoperf-client -n &lt;namespace&gt; &lt;pod-name&gt; -c &lt;container name&gt; -o &lt;output directory&gt;
</code></pre>
<h3 id="api"><a class="header" href="#api">API</a></h3>
<pre><code class="language-protobuf">service NecoPerf {
    rpc Profile(ProfileRequest) returns (ProfileResponse);
}

message ProfileRequest {
    string container_id = 1;
    int64 timeout_seconds = 2;
}

message ProfileResponse {
    bytes data = 1;
}
</code></pre>
<h3 id="system-context-diagram"><a class="header" href="#system-context-diagram">System Context Diagram</a></h3>
<p>NecoPerf system overview diagram is shown below.</p>
<pre><code class="language-mermaid">graph TD;
    User--&gt;|exec|necoperf-client
    necoperf-client--&gt;|GET|k8s-api-server[kube-apiserver]
    necoperf-client --&gt;|gRPC call|necoperf-daemon

subgraph node1
    necoperf-daemon--&gt;|CRI call|CRI
    perf--&gt;|profile|pod[target pod]
    perf-.-&gt;|export/read|perf.data((necoperf.data))
    perf-.-&gt;|export|perf.script((necoperf.script))
    necoperf-daemon--&gt;|exec|perf
    subgraph daemonset
        necoperf-daemon
    end
end

subgraph your-pod
    necoperf-client-.-&gt;|export|result((result))
end
</code></pre>
<h2 id="alternatives"><a class="header" href="#alternatives">Alternatives</a></h2>
<p>This section lists some existing systems and explains why they are not used.</p>
<ul>
<li><a href="https://github.com/IBM/perf-sidecar-injector">IBM/perf-sidecar-injector</a>
<ul>
<li>perf-sidecar-injector is a mutating webhook that adds a perf container as a sidecar container</li>
<li>perf-sidecar-injector requires privileged permission to run the perf container</li>
<li>To access the target container from the sidecar, the Pod setting <code>shareProcessNamespace</code> must be enabled.
Enabling <code>shareProcessNamespace</code> settings allows other containers in the pod to see environment variables and file systems.
Some tenant may not accept this case.</li>
</ul>
</li>
<li><a href="https://github.com/yahoo/kubectl-flame">yahoo/kubectl-flame</a>
<ul>
<li>kubectl-flame is a kubectl plugin that allows profiling of applications on kubernetes</li>
<li>kubectl-flame performs profiling of NodeJS applications by using perf.</li>
<li>The command-line arguments of kubectl-flame's perf are hard-coded and the arguments cannot be changed except for the execution time.
<a href="https://github.com/yahoo/kubectl-flame/blob/master/agent/profiler/perf.go#L60">https://github.com/yahoo/kubectl-flame/blob/master/agent/profiler/perf.go#L60</a></li>
<li>kubectl-flame only supports docker runtime and does not support containerd runtime.
<a href="https://github.com/yahoo/kubectl-flame/issues/51">https://github.com/yahoo/kubectl-flame/issues/51</a></li>
</ul>
</li>
<li><a href="https://github.com/iovisor/kubectl-trace">iovisor/kubectl-trace</a>
<ul>
<li>kubectl-trace is a kubectl plugin to schedule bpftrace programmers against Pods on a Kubernetes cluster</li>
<li>kubectl-trace only supports tracing against Pods and does not support profiling</li>
</ul>
</li>
<li><a href="https://github.com/giannisalinetti/perf-utils">giannisalinetti/perf-utils</a>
<ul>
<li>The container image of perf-utils installs tools for performance analysis and troubleshooting for immutable systems such as Fedora CoreOS</li>
<li>perf-utils does not install a perf compatible with the host kernel version</li>
</ul>
</li>
</ul>
<p>Explains the problems with the sidecar container method and the Ephemeral Container method.</p>
<ul>
<li>The sidecar container method requires the sidecar container to be deployed beforehand.
If you deploy the sidecar container later, you must tolerate the pod to restart.</li>
<li>As of Kubernetes 1.26, once an Ephemeral Container is added to a Pod, it cannot be changed or removed
<blockquote>
<p>Like regular containers, you may not change or remove an ephemeral container after you have added it to a Pod.
<a href="https://kubernetes.io/docs/concepts/workloads/pods/ephemeral-containers/#understanding-ephemeral-containers">Ephemeral Container</a></p>
</blockquote>
</li>
<li>The cluster administrator needs to authorise the tenant to set permissions such as <code>CAP_SYS_ADMIN</code> to Pod</li>
<li>It is difficult for tenant to prepare a version of perf command that is compatible with the host OS</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="release.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="release.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
